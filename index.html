<!DOCTYPE html>
<html>
<head>
  <title>Exercise Logger</title>
  <meta charset="utf-8" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; font-size: 2.5em; }
    .step { margin-bottom: 40px; }
    button {
      margin: 10px;
      padding: 25px 45px;
      font-size: 1em;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      font-size: 0.6em;
    }
    th, td {
      border: 1px solid #888;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #eee; }
    .panel {
      border: 2px solid #ccc;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 30px;
      background: #fafafa;
      font-size: 0.6em;
    }
    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; }
    .row > * { flex: 0 0 auto; }
    select { font-size: 1em; padding: 10px; }
    .pill {
      display: inline-block;
      padding: 8px 14px;
      margin: 4px;
      border-radius: 999px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      font-size: 0.8em;
    }
    .muted { color: #666; }
    .bold { font-weight: bold; }
  </style>
</head>
<body>

  <h1>Exercise Logger</h1>

  <!-- Input step flow -->
  <div id="stepContainer" class="step"></div>

  <!-- Latest input (24h) panel + quick actions -->
  <div id="latestContainer"></div>

  <!-- Logs table -->
  <div id="logTableContainer"></div>

  <script>
    let log = {};
    let mode = null; // 'swim' | 'heavy' | 'finger'
    const logs = [];
    const stepContainer = document.getElementById("stepContainer");
    const logTableContainer = document.getElementById("logTableContainer");
    const latestContainer = document.getElementById("latestContainer");

    /* ----------------------------
       Helpers: date & rendering
    -----------------------------*/
    function getToday() {
      const d = new Date();
      return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    }

    function renderStep(content) {
      stepContainer.innerHTML = "";
      stepContainer.appendChild(content);
    }

    function createButton(text, onClick) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.onclick = onClick;
      return btn;
    }

    function generateRange(start, end, step, unit) {
      let arr = [];
      for (let i = start; i <= end; i += step) {
        arr.push(`${i}${unit}`);
      }
      return arr;
    }

    /* ----------------------------
       Latest Input (24h) storage
    -----------------------------*/
    const LATEST_KEY = "exercise_logger_latest_input";

    function saveLatestInput(entry) {
      const payload = { entry, ts: Date.now() };
      localStorage.setItem(LATEST_KEY, JSON.stringify(payload));
    }

    function loadLatestInput() {
      try {
        const raw = localStorage.getItem(LATEST_KEY);
        if (!raw) return null;
        const payload = JSON.parse(raw);
        const maxAge = 24 * 60 * 60 * 1000; // 24h
        if ((Date.now() - payload.ts) > maxAge) {
          localStorage.removeItem(LATEST_KEY);
          return null;
        }
        return payload.entry;
      } catch (e) {
        return null;
      }
    }

    function clearLatestIfExpired() {
      loadLatestInput(); // already clears if expired
    }

    /* ----------------------------
       Parsing / normalization
    -----------------------------*/
    function parseSets(sets) {
      if (sets == null) return null;
      if (typeof sets === "number") return sets; // swim/finger may use numeric sets
      const m = String(sets).match(/(\d+)/);
      return m ? parseInt(m[1], 10) : null;
    }

    function formatSetsAlwaysPlural(n) {
      return `${n} sets`; // always "sets", even for 1 (per export standard)
    }

    function formatSetsLikeOriginal(oldSets, n) {
      if (typeof oldSets === "number") return n; // keep numeric if numeric before
      return formatSetsAlwaysPlural(n);
    }

    function incrementSets(sets, delta) {
      const n = parseSets(sets);
      if (n == null) return sets;
      const nn = Math.max(1, n + delta);
      return formatSetsLikeOriginal(sets, nn);
    }

    function parseReps(reps) {
      if (!reps) return null;
      // numeric pattern like "10 reps"; swim/finger durations return null
      const m = String(reps).match(/(\d+)\s*reps/i);
      if (m) return parseInt(m[1], 10);
      return null;
    }

    function changeRepsValue(reps, delta) {
      const n = parseReps(reps);
      if (n == null) return reps; // can't change non-numeric reps (e.g., "30m" or "30s")
      const nn = Math.max(1, n + delta); // delta may be negative or positive
      return `${nn} reps`;
    }

    function parseWeightKg(weight) {
      if (!weight) return null;
      const s = String(weight).trim();
      if (!/kg$/i.test(s)) return null;
      const num = parseFloat(s.replace(/kg/i, ""));
      return isNaN(num) ? null : num;
    }

    function adjustWeight(weight, deltaKg) {
      const w = parseWeightKg(weight);
      if (w == null) return weight; // can't parse (e.g., "—" or swims)
      const nw = Math.max(0, w + deltaKg); // deltaKg can be negative
      const hadDecimal = /\d+\.\d+/.test(String(weight));
      const display = hadDecimal ? nw.toFixed(1) : String(Math.round(nw));
      return `${display}kg`;
    }

    /* --------------------------------------
       Latest Input Panel + Quick Next Steps
    ---------------------------------------*/
    function renderLatestInput() {
      clearLatestIfExpired();
      latestContainer.innerHTML = "";

      const latest = loadLatestInput();

      const panel = document.createElement("div");
      panel.className = "panel";
      const title = document.createElement("div");
      title.innerHTML = "<div class='bold' style='font-size:1.2em;margin-bottom:10px;'>Input Record (saved for 24 hours)</div>";
      panel.appendChild(title);

      if (!latest) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No recent input in the last 24 hours.";
        panel.appendChild(empty);
        latestContainer.appendChild(panel);
        return;
      }

      // Summary chips
      const sum = document.createElement("div");
      sum.style.marginBottom = "14px";
      sum.innerHTML = `
        <span class="pill"><span class="muted">Date:</span> ${latest.date || "—"}</span>
        <span class="pill"><span class="muted">Part:</span> ${latest.part || "—"}</span>
        <span class="pill"><span class="muted">Exercise:</span> ${latest.exercise || "—"}</span>
        <span class="pill"><span class="muted">Equip:</span> ${latest.equipment || "—"}</span>
        <span class="pill"><span class="muted">Weight:</span> ${latest.weight || "—"}</span>
        <span class="pill"><span class="muted">Reps:</span> ${latest.reps || "—"}</span>
        <span class="pill"><span class="muted">Sets:</span> ${typeof latest.sets === "number" ? formatSetsAlwaysPlural(latest.sets) : (latest.sets || "—")}</span>
      `;
      panel.appendChild(sum);

      // Quick actions
      const header = document.createElement("div");
      header.className = "bold";
      header.style.marginBottom = "8px";
      header.textContent = "Next Step";
      panel.appendChild(header);

      const row = document.createElement("div");
      row.className = "row";

      // +1 set → duplicate the last entry exactly
      row.appendChild(createButton("+ 1 set", () => {
        const base = structuredClone(latest);
        commitNewFromLatest(base);
      }));

      // Reduce reps → dropdown 1-5 (negative delta)
      const repsWrap = document.createElement("div");
      const repsLabel = document.createElement("div");
      repsLabel.className = "muted";
      repsLabel.textContent = "Reduce reps:";
      const repsSelect = document.createElement("select");
      [1,2,3,4,5].forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        repsSelect.appendChild(opt);
      });
      const repsBtn = createButton("Apply", () => {
        const delta = -parseInt(repsSelect.value, 10);
        const base = structuredClone(latest);
        const modified = { ...base, reps: changeRepsValue(base.reps, delta) };
        commitNewFromLatest(modified);
      });
      repsWrap.appendChild(repsLabel);
      repsWrap.appendChild(repsSelect);
      repsWrap.appendChild(repsBtn);
      row.appendChild(repsWrap);

      // Reduce weight → choose decrement; also reps Δ (-5..+5)
      const wtWrap = document.createElement("div");
      const wtLabel = document.createElement("div");
      wtLabel.className = "muted";
      wtLabel.textContent = "Reduce weight (ask reps Δ):";
      wtWrap.appendChild(wtLabel);

      const repsDeltaLabel = document.createElement("div");
      repsDeltaLabel.className = "muted";
      repsDeltaLabel.textContent = "Reps Δ (-5..+5, default 0)";
      const repsDeltaSelect = document.createElement("select");
      for (let n = -5; n <= 5; n++) {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        if (n === 0) opt.selected = true;
        repsDeltaSelect.appendChild(opt);
      }
      wtWrap.appendChild(repsDeltaLabel);
      wtWrap.appendChild(repsDeltaSelect);

      [5,10,20].forEach(n => {
        wtWrap.appendChild(createButton(`-${n}`, () => {
          const repsDelta = parseInt(repsDeltaSelect.value, 10) || 0;
          const base = structuredClone(latest);
          const modified = {
            ...base,
            weight: adjustWeight(base.weight, -n),
            reps: changeRepsValue(base.reps, repsDelta)
          };
          commitNewFromLatest(modified);
        }));
      });
      row.appendChild(wtWrap);

      panel.appendChild(row);
      latestContainer.appendChild(panel);
    }

    function commitNewFromLatest(newEntry) {
      logs.push(newEntry);
      saveLatestInput(newEntry);
      renderTable();
      renderLatestInput();
    }

    /* ----------------------------
       Core flow: steps and logging
    -----------------------------*/
    function start() {
      log = {
        date: getToday(),
        weight: "—",
        reps: "—",
        sets: "—",
        notes: ""
      };
      const div = document.createElement("div");
      div.innerHTML = "<strong>1. What did you do?</strong><br><br>";
      div.appendChild(createButton("Swim", () => {
        mode = 'swim';
        log.part = "Swim";
        log.exercise = "—";
        log.equipment = "Pool";
        stepSwim();
      }));
      div.appendChild(createButton("Finger Hang", () => {
        mode = 'finger';
        log.part = "Grip";
        log.exercise = "Finger Hang";
        log.equipment = "Hangboard";
        stepFingerHangDuration();
      }));
      div.appendChild(createButton("Heavy Lift", () => {
        mode = 'heavy';
        stepBodyPart();
      }));
      renderStep(div);

      // Render latest input panel on load
      renderLatestInput();
    }

    function stepSwim() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Times × 30m</strong><br><br>";
      for (let i = 1; i <= 12; i++) {
        div.appendChild(createButton(i, () => {
          log.reps = "30m";
          log.sets = i; // numeric sets for swim
          finalizeLog();
        }));
      }
      renderStep(div);
    }

    // New: Finger Hang flow (ask duration then sets)
    function stepFingerHangDuration() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Finger Hang — Duration</strong><br><br>";
      ["30s", "45s", "1 min"].forEach(label => {
        div.appendChild(createButton(label, () => {
          log.reps = label; // store as duration string
          stepFingerHangSets();
        }));
      });
      renderStep(div);
    }

    function stepFingerHangSets() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Sets</strong><br><br>";
      for (let i = 1; i <= 12; i++) {
        div.appendChild(createButton(i, () => {
          log.sets = i; // numeric sets
          finalizeLog();
        }));
      }
      renderStep(div);
    }

    function stepBodyPart() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Select Body Part</strong><br><br>";
      div.appendChild(createButton("Chest", () => {
        log.part = "Chest";
        stepChestEquipment();
      }));
      div.appendChild(createButton("Back", () => {
        log.part = "Back";
        stepBackType();
      }));
      div.appendChild(createButton("Leg", () => {
        stepLegType();
      }));
      renderStep(div);
    }

    function stepBackType() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Back - Type</strong><br><br>";
      div.appendChild(createButton("Machine", () => {
        stepBackGrip("Machine");
      }));
      div.appendChild(createButton("Seat Row", () => {
        stepBackGrip("Seat Row");
      }));
      // New: Pull Up entry point
      div.appendChild(createButton("Pull Up", () => {
        stepPullUp();
      }));
      renderStep(div);
    }

    function stepBackGrip(equipment) {
      const div = document.createElement("div");
      div.innerHTML = `<strong>${equipment} - Grip Type</strong><br><br>`;
      div.appendChild(createButton("Normal", () => {
        log.exercise = `${equipment} - Normal`;
        log.equipment = equipment;
        stepWeight(["35kg", "42kg", "49kg", "56kg", "63kg", "70kg", "77kg", "84kg", "91kg"]);
      }));
      div.appendChild(createButton("Close Grip", () => {
        log.exercise = `${equipment} - Close Grip`;
        log.equipment = equipment;
        stepWeight(["35kg", "42kg", "49kg", "56kg", "63kg", "70kg", "77kg", "84kg", "91kg"]);
      }));
      renderStep(div);
    }

    // New: Pull Up flow (ask reps then sets, record bodyweight 72kg)
    function stepPullUp() {
      log.exercise = "Pull Up";
      log.equipment = "Bar";
      log.weight = "72kg"; // bodyweight record
      stepPullUpReps();
    }

    function stepPullUpReps() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Pull Up — Reps</strong><br><br>";
      for (let i = 1; i <= 25; i++) {
        div.appendChild(createButton(i, () => {
          log.reps = `${i} reps`;
          stepPullUpSets();
        }));
      }
      renderStep(div);
    }

    function stepPullUpSets() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Pull Up — Sets</strong><br><br>";
      for (let i = 1; i <= 10; i++) {
        div.appendChild(createButton(i, () => {
          log.sets = `${i} sets`;
          finalizeLog();
        }));
      }
      renderStep(div);
    }

    function stepChestEquipment() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Chest - Equipment</strong><br><br>";

      div.appendChild(createButton("Dumbbell", () => {
        const areaDiv = document.createElement("div");
        areaDiv.innerHTML = "<strong>Dumbbell Exercise</strong><br><br>";
        areaDiv.appendChild(createButton("Flat Dumbbell Press", () => {
          log.exercise = "Flat Dumbbell Press";
          log.equipment = "Dumbbell";
          stepWeight(generateRange(10, 30, 2, "kg"));
        }));
        areaDiv.appendChild(createButton("Incline Dumbbell Press", () => {
          log.exercise = "Incline Dumbbell Press";
          log.equipment = "Dumbbell";
          stepWeight(generateRange(10, 30, 2, "kg"));
        }));
        areaDiv.appendChild(createButton("Dumbbell Fly", () => {
          log.exercise = "Dumbbell Fly";
          log.equipment = "Dumbbell";
          stepWeight(generateRange(10, 30, 2, "kg"));
        }));
        renderStep(areaDiv);
      }));

      div.appendChild(createButton("Smith Machine", () => {
        const smithDiv = document.createElement("div");
        smithDiv.innerHTML = "<strong>Smith Press</strong><br><br>";
        smithDiv.appendChild(createButton("Flat Smith Press", () => {
          log.exercise = "Flat Smith Press";
          log.equipment = "Smith Machine";
          stepWeight(generateRange(20, 100, 10, "kg"));
        }));
        smithDiv.appendChild(createButton("Incline Smith Press", () => {
          log.exercise = "Incline Smith Press";
          log.equipment = "Smith Machine";
          stepWeight(generateRange(20, 100, 10, "kg"));
        }));
        renderStep(smithDiv);
      }));

      div.appendChild(createButton("Cable Machine", () => {
        const cableDiv = document.createElement("div");
        cableDiv.innerHTML = "<strong>Cable Chest</strong><br><br>";
        cableDiv.appendChild(createButton("Cable Chest Press", () => {
          log.exercise = "Cable Chest Press";
          log.equipment = "Cable Machine";
          stepWeight(getChestWeights("Cable Machine"));
        }));
        cableDiv.appendChild(createButton("Cable Fly", () => {
          log.exercise = "Cable Fly";
          log.equipment = "Cable Machine";
          stepWeight(getChestWeights("Cable Machine"));
        }));
        renderStep(cableDiv);
      }));

      div.appendChild(createButton("Machine", () => {
        const machineDiv = document.createElement("div");
        machineDiv.innerHTML = "<strong>Machine Chest</strong><br><br>";
        machineDiv.appendChild(createButton("Chest Press", () => {
          log.exercise = "Chest Press";
          log.equipment = "Machine";
          stepWeight(["70kg"]);
        }));
        machineDiv.appendChild(createButton("Machine Fly", () => {
          log.exercise = "Machine Fly";
          log.equipment = "Machine";
          stepWeight(["35kg"]);
        }));
        renderStep(machineDiv);
      }));

      renderStep(div);
    }

    function getChestWeights(equipment) {
      if (equipment === "Cable Machine") {
        return [
          "1.1kg", "3.4kg", "5.7kg", "9.0kg", "10.2kg", "12.5kg", "14.7kg",
          "17.0kg", "19.3kg", "21.6kg", "23.8kg", "26.2kg", "28.4kg", "30.6kg", "32.9kg"
        ];
      } else {
        return generateRange(10, 30, 2, "kg");
      }
    }

    function stepLegType() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Leg - Type</strong><br><br>";
      div.appendChild(createButton("Stretch", () => {
        log.part = "Leg";
        log.exercise = "Stretch";
        log.equipment = "None";
        log.weight = "—";
        log.reps = "—";
        log.sets = "—";
        finalizeLog();
      }));
      div.appendChild(createButton("Exercise", () => {
        stepLegPart();
      }));
      renderStep(div);
    }

    function stepLegPart() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Leg - Which part?</strong><br><br>";
      div.appendChild(createButton("Gluteus", () => {
        log.part = "Glutes";
        log.exercise = "Gluteus";
        log.equipment = "Dumbbell";
        stepWeight(generateRange(2, 20, 2, "kg"));
      }));
      div.appendChild(createButton("Quadriceps", () => {
        log.part = "Legs";
        log.exercise = "Quadriceps";
        log.equipment = "Dumbbell";
        stepWeight(generateRange(2, 20, 2, "kg"));
      }));
      renderStep(div);
    }

    function stepWeight(weightList) {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Select Weight</strong><br><br>";
      weightList.forEach(w => {
        div.appendChild(createButton(w, () => {
          log.weight = w;
          stepReps();
        }));
      });
      renderStep(div);
    }

    // For HEAVY default: do NOT ask sets/notes; default sets = 1 and finalize after reps
    function stepReps() {
      const div = document.createElement("div");
      div.innerHTML = "<strong>Reps</strong><br><br>";
      for (let i = 4; i <= 15; i++) {
        div.appendChild(createButton(i, () => {
          log.reps = `${i} reps`;
          if (mode === 'heavy') {
            log.sets = "1 sets"; // store pluralized for export standard
            finalizeLog();
          } else {
            finalizeLog();
          }
        }));
      }
      renderStep(div);
    }

    function finalizeLog() {
      logs.push({ ...log });
      saveLatestInput({ ...log }); // base for quick actions
      renderTable();
      renderLatestInput();
      start();
    }

    /* ----------------------------
       Export formatting (standard)
       Example:
       2025/9/18, Chest, Flat Smith Press, Smith Machine, 80kg, 8reps, 1 sets
    -----------------------------*/
    function exportLineStandard(e) {
      const date = e.date || "";
      const part = e.part || "";
      const exercise = e.exercise || "";
      const equipment = e.equipment || "";
      const weight = e.weight || "";
      // reps: remove space before "reps" if numeric
      let repsOut = "";
      const repsNum = parseReps(e.reps);
      if (repsNum != null) {
        repsOut = `${repsNum}reps`;
      } else {
        repsOut = e.reps || "";
      }
      // sets: always "<n> sets"
      const nsets = parseSets(e.sets);
      const setsOut = nsets != null ? `${nsets} sets` : (e.sets || "");

      return `${date}, ${part}, ${exercise}, ${equipment}, ${weight}, ${repsOut}, ${setsOut}`;
    }

    function renderTable() {
      const table = document.createElement("table");
      table.innerHTML = `
        <tr>
          <th>Date</th><th>Body Part</th><th>Exercise</th><th>Equipment</th>
          <th>Weight</th><th>Reps</th><th>Sets</th><th>Notes</th>
        </tr>
        ${logs.map(e => `
          <tr>
            <td>${e.date || "—"}</td>
            <td>${e.part || "—"}</td>
            <td>${e.exercise || "—"}</td>
            <td>${e.equipment || "—"}</td>
            <td>${e.weight || "—"}</td>
            <td>${e.reps || "—"}</td>
            <td>${typeof e.sets === "number" ? formatSetsAlwaysPlural(e.sets) : (e.sets || "—")}</td>
            <td>${e.notes || ""}</td>
          </tr>
        `).join("")}
      `;
      logTableContainer.innerHTML = "";
      logTableContainer.appendChild(table);

      // Build export summary in the requested standard format
      const summary = logs.map(exportLineStandard).join("\n");
      const encoded = encodeURIComponent(summary);
      const shortcutURL = `shortcuts://run-shortcut?name=SaveToNotes&input=${encoded}`;
      const saveBtn = createButton("Save to iPhone Notes", () => { window.location.href = shortcutURL; });
      logTableContainer.appendChild(saveBtn);
    }

    // Boot
    start();
  </script>

</body>
</html>
